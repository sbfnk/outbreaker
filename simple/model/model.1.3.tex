% Template for PLoS
% Version 1.0 January 2009
%
% To compile to pdf, run:
% latex plos.template
% bibtex plos.template
% latex plos.template
% latex plos.template
% dvipdf plos.template

\documentclass[10pt]{article}

% amsmath package, useful for mathematical formulas
\usepackage{amsmath}
% amssymb package, useful for mathematical symbols
\usepackage{amssymb}

% graphicx package, useful for including eps and pdf graphics
% include graphics with the command \includegraphics
\usepackage{graphicx}

% cite package, to clean up citations in the main text. Do not remove.
\usepackage{cite}

\usepackage{color} 

% Use doublespacing - comment out for single spacing
%\usepackage{setspace} 
%\doublespacing

\usepackage[frenchb,english]{babel}
\usepackage{bm}
\usepackage{cite}
\usepackage{amsthm}
\usepackage{amsfonts}
\usepackage{ccaption}
\usepackage{url}

% Text layout
\topmargin 0.0cm
\oddsidemargin 0.5cm
\evensidemargin 0.5cm
\textwidth 16cm 
\textheight 21cm

% Bold the 'Figure #' in the caption and separate it with a period
% Captions will be left justified
\usepackage[labelfont=bf,labelsep=period,justification=raggedright]{caption}

% Remove brackets from numbering in List of References
\makeatletter
\renewcommand{\@biblabel}[1]{\quad#1.}
\makeatother

\author{In alphabetic order: \\Simon Cauchemez, Anne Cori, Xavier Didelot, \\Neil Ferguson, Christophe Fraser, Thibaut Jombart,\\...}
\title{Reconstructing transmission trees from genetic data: \\a Bayesian approach}

\begin{document}

% Title must be 150 words or less
% \begin{flushleft}
\maketitle

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Purpose of the model}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
We seek a probabilistic model allowing to reconstruct the transmission tree of a disease outbreak based on RNA/DNA sequences sampled at given time points.
We consider a single pathogen and genetic sequence per infection.
The generation time is assumed to follow a known distribution.
The transmission tree and the mutation rates are the elements we want to infer.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Data and parameters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection*{Data}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
For each patient $i=1,\ldots,n$ we note the data:
\begin{itemize}
	\item $s_i$: the genetic sequence obtained for patient $i$.
	\item $t_i$: the collection time for $s_i$ (time is considered as a discrete variable).
%  	\item $d_{i,j}$: the number of transitions between $s_i$ and $s_j$
%  	\item $g_{i,j}$: the number of transversions between $s_i$ and $s_j$
%  	\item $l_{i,j}$: the number of nucleotide positions typed in both $s_i$ and $s_j$
%  	\item $w(\Delta_t)$: likelihood function for a secondary infection occuring $\Delta_t$ unit times after the primary infection; we assume $w(\Delta_t)=0$ for $\Delta_t \leq 0$.
\end{itemize}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection*{Augmented data}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Augmented data are noted using capital latin letters:
\begin{itemize}
	\item $T_i^{inf}$: time at which patient $i$ has been infected.
        \item $A_i$: the closest observed ancestor of $i$ in the infection tree; $A_i=j$ indicates that $j$ has infected $i$, either directly, or with one or several intermediate generations, which were unobserved.
	\item $K_i$: an integer $\geq 1$ indicating how many generations separate $A_i$ and $i$: $K_i=1$ indicates that $A_i$ infected $i$; $K_i=2$ indicates that $j$ has infected an unobserved individual, who has in turn infected $i$.
	\item $T_i^{ini}$: time at which $A_i$ caused the initial infection of the lineage of $i$. For $K_i=1$, $T_i^{inf} = T_i^{ini}$.
\end{itemize}

As a first simple approach, $K_i$ could be set to $1$ for all $i$, hence assuming that the whole outbreak was observed.



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection*{Functions}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
We use the following functions of the data/augmented data:
\begin{itemize}
	\item $d(i,j)$: the number of transitions between $s_i$ and $s_j$.
 	\item $g(i,j)$: the number of transversions between $s_i$ and $s_j$.
 	\item $l(i,j)$: the number of nucleotide positions typed in both $s_i$ and $s_j$.
 	\item $w(\Delta_t)$: generation time distribution (likelihood function for a secondary infection occuring $\Delta_t$ unit times after the primary infection); we assume $w(\Delta_t)=0$ for $\Delta_t \leq 0$; while not a requirement in theory, in practice this function will be truncated at a value $\Delta_{max}$ so that $w(\Delta_t)=0$ if $\Delta_t \geq \Delta_{max}$.
\end{itemize}





%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection*{Parameters}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
Parameters are indicated using greek letters:
\begin{itemize}
	\item $\mu_1$: rates of transitions, given per site and unit time (likely day).
	\item $\mu_2 $: rate of transversions, parametrised as $\mu_2 = \kappa \mu_1$ to account for the correlation between the two rates.
\end{itemize}






%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section*{Model}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
This model assumes that cases are ordered by increasing infection dates ($T_i^{inf} \leq T_{i+1}^{inf}$).
The posterior distribution is proportional to the joint distribution:
\begin{eqnarray}
& & p(\{s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i\}_{(i=1,\ldots,n)}, w, \mu_1, \kappa)\\
& = & p(\{s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i\}_{(i=1,\ldots,n)}| w, \mu_1, \kappa) \times p(w, \mu_1, \kappa)
\end{eqnarray}
where the first term is the likelihood of observed and augmented data, and the second, the prior.
The likelihood can be decomposed as:

\begin{eqnarray}
& & p(\{s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i\}_{(i=1,\ldots,n)}| w, \mu_1, \kappa) \\
& = & \prod_{i=2}^n p(s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i | \{s_k, t_k, T_k^{inf},T_k^{ini}, A_k, K_k | w, \mu_1, \kappa\}_{(k=1,\ldots,i-1)}) \nonumber \\ 
& & \times p(s_1, t_1, T_1^{inf}, T_1^{ini}, A_1, K_1 | w, \mu_1, \kappa)\\
& = & \prod_{i=2}^n p(s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i| s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& & \times p(s_1, t_1, T_1^{inf}, T_1^{ini},A_1, K_1 | w, \mu_1, \kappa)
\end{eqnarray}


The term $p(s_1, t_1, T_1^{inf}, T_1^{ini}, A_1, K_1 | w, \mu_1, \kappa)$ is the probability of the first infection, treated as a constant.
This may be modified if we explicitely model infections from outside the system.
The term for case $i$ ($i=2,\ldots,n$) is:
\begin{equation}
 p(s_i, t_i, T_i^{inf},T_i^{ini}, A_i, K_i| s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa )
\end{equation}
which can be decomposed into:
\begin{eqnarray}
& & p(s_i | t_i, T_i^{inf}, T_i^{ini}, A_i, K_i, s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& &  \times  p(t_i | T_i^{inf}, T_i^{ini}, A_i, K_i, s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& & \times  p(T_i^{inf}| T_i^{ini}, A_i, K_i, s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& & \times  p(T_i^{ini}| A_i, K_i, s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& & \times  p(A_i, K_i| s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa) \nonumber \\
& = & 
\underbrace{p(s_i | t_i, T_i^{ini}, A_i, s_{A_i}, t_{A_i}, \mu_1, \kappa)}_{\Omega_i^1} \nonumber \\
& &  \times  \underbrace{p(t_i | T_i^{inf}, w) 
 p(T_i^{inf}| K_i, T_i^{ini}, w)
 p(T_i^{ini}| T_{A_i}^{inf}, w)}_{\Omega_i^2} \nonumber \\
& & \times  \underbrace{p(A_i, K_i| s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa)}_{\Omega_i^3}\nonumber \\
% = \underbrace{p(s_i | t_i, T_i^{inf},T_i^{ini}, A_i, s_{A_i}, t_{A_i}, \mu_1, \kappa)}_{\Omega_i^1}  
%     \underbrace{p(t_i | T_i^{inf}, w)
% 		p(T_i^{inf} | T_i^{ini}, A_i, T_{A_i}^{inf}, K_i, w) % !! ANNE check if T_i^{ini} is relevant here
% 		p(T_i^{ini} | A_i, T_{A_i}^{inf}, K_i, w)}_{\Omega_i^2}
%     \underbrace{p(A_i, K_i | s_{A_i}, t_{A_i}, T_{A_i}^{inf}, w, \mu_1, \kappa)}_{\Omega_i^3} &
\end{eqnarray}
\noindent where $\Omega_i^1$ is the genetic likelihood, $\Omega_i^2$ if the epidemiological likelihood (derived from W\&T), and $\Omega_i^3$ are priors for the augmented data $A_i$ and $K_i$.
\\




Assuming that there is no within-host diversity, $\Omega_i^1$ is computed as: 
%% BINOMIAL VERSION %%
\begin{equation}
\underbrace{\mathcal{B}\left(d(i,A_i) | (t_i - t_{A_i}) l(i,A_i), \mu_1 \right)}_{\mbox{transitions}}
\times 
\underbrace{\mathcal{B}\left(g(i,A_i) | (t_i - t_{A_i}) l(i,A_i), \kappa \mu_1 \right)}_{\mbox{transversions}}
\end{equation}

if $t_{A_i} \leq T_i^{ini} $, and as:
\begin{equation}
\underbrace{\mathcal{B}\left(d(i,A_i) | (t_{A_i} - T_i^{ini} + t_i - T_i^{ini}) l(i,A_i), \mu_1 \right)}_{\mbox{transitions}}
\times 
\underbrace{\mathcal{B}\left(g(i,A_i) | (t_{A_i} - T_i^{ini} + t_i - T_i^{ini}) l(i,A_i), \kappa \mu_1 \right)}_{\mbox{transversions}}
\end{equation}
otherwise; $\mathcal{B}(. | n, p)$ is the probability mass function of a Binomial distribution with $n$ draws and a probability $p$.
~\\

%% POISSON VERSION %%
% $$
% \underbrace{\mathcal{P}\left(d(i,A_i) | (t_i - t_{A_i}) l(i,A_i) \mu_1 \right)}_{\mbox{transitions}}
% \times 
% \underbrace{\mathcal{P}\left(g(i,A_i) | (t_i - t_{A_i}) l(i,A_i) \kappa \right)}_{\mbox{transversions}}
% $$
% if $t_{A_i} \leq T_i^{inf} $, and as:
% $$
% \underbrace{\mathcal{P}\left(d(i,A_i) | (t_{A_i} - T_i^{inf} + t_i - T_i^{inf}) l(i,A_i) \mu_1 \right)}_{\mbox{transitions}}
% \times 
% \underbrace{\mathcal{P}\left(g(i,A_i) | (t_{A_i} - T_i^{inf} + t_i - T_i^{inf}) l(i,A_i) \kappa \right)}_{\mbox{transversions}}
% $$
% otherwise; $\mathcal{P}(. | \lambda)$ is the density of a Poisson distribution of parameter $\lambda$.
% 
% Note that when the genetic likelihood cannot be computed (i.e. $s_i$ or $s_j$ is missing, or the two sequences have no typed nucleotide position in common), it can be replaced by the average likelihood of the other $\Omega_i^{1}$
~\\





$\Omega_i^2$ is determined by the (known) distribution of the generation time, and the collection and infection dates:
\begin{eqnarray}
 \Omega_i^2 & = & p(t_i | T_i^{inf}, w) \times p(T_i^{inf}| K_i,T_i^{ini}, w) \times p(T_i^{ini}| T_{A_i}^{inf}, w) \nonumber \\
& = &  w(t_i - T_i^{inf}) \times  w^{\left(K_i-1\right)}(T_i^{inf} - T_i^{ini}) \times w(T_i^{ini} - T_{A_i}^{inf})
% & = &  \mathbf{1}_{\{w(t_i - T_i^{inf}) > 0\}} \times  w^{\left(K_i\right)}(T_i^{inf} - T_{A_i}^{inf})
\end{eqnarray}
with $\mathbf{1}$ the indicator function and $w^{\left(k\right)} = \underbrace{w*w*\ldots*w}_{k \text{ times}} $, where $*$ denotes the convolution operator, defined, for two discrete distributions $a$ and $b$, by $\left(a*b\right)\left(t\right) = \sum_{u=-\infty}^{+\infty} a\left(t-u\right)b\left(u\right)$. By convention, $w^{\left(0\right)}\left(t\right) = 1$.
The first term assumes that the probability of sequencing an isolate at time $t_i$ is proportional to the infectiousness of the host at this time.
The second term is an extension of Wallinga \& Teunis's model for $K_i-1$ unobserved intermediate infections.
The third term is a strict application of Wallinga \& Teunis's model for the initial infection.
\\


The term $\Omega_i^3$ can be rewritten as:
\begin{eqnarray}
\Omega_i^3 &=&  p(A_i, K_i| s_{A_i}, t_{A_i}, T_{A_i}^{inf}, T_{A_i}^{ini}, w, \mu_1, \kappa)\\
% &=&  p(A_i, K_i, w, \mu_1, \kappa)\\
% 	 &=&  p(w | s_{A_i}, t_{A_i}, T_{A_i}^{inf}) 
% 	      p(A_i, K_i,\mu_1, \kappa | s_{A_i}, t_{A_i}, T_{A_i}^{inf}) \\
% 	 &=&  p(w | s_{A_i}, t_{A_i}, T_{A_i}^{inf}) \nonumber \\
%       & &     p(A_i | s_{A_i}, t_{A_i}, T_{A_i}^{inf})\nonumber  \\
%       & &     p(K_i | s_{A_i}, t_{A_i}, T_{A_i}^{inf}) \nonumber \\
%       & &     p(\mu_1 | s_{A_i}, t_{A_i}, T_{A_i}^{inf})\nonumber  \\
%       & &     p(\kappa | s_{A_i}, t_{A_i}, T_{A_i}^{inf})\\
      & = &   p(A_i) p(K_i)
\end{eqnarray}
as the different components are independent.
% $p(w)$ is a constant and does not need to be known to sample from (1).
$p(A_i)$ is the prior on ancestries, set to $1/(n-1)$.
$p(K_i)$ is the prior on the number of unobserved transmission steps.
This is given by a binomial distribution of parameter $\pi$, which is the proportion of observed (sampled) cases in the outbreak.
If we assume that the entire outbreak has been sampled, this would be set to $p(K_i) = \mathbf{1}_{\left\lbrace K_i=1\right\rbrace}$.
% Alternatively, more flexibility would be gained by using a Poisson distribution to allow for unobserved intermediate cases.
% , where $\mathbf{1}_{\left\lbrace.\right\rbrace}$ denotes the indicator function, defined by $\mathbf{1}_{\left\lbrace X \right\rbrace}=1$ if $X$ is true, and $0$ otherwise. 
% $ p(\mu_1)$ and $p(\kappa)$ are the priors for these two parameters.
~\\


% 
% 
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \section*{Model with missing data}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% !!! Need to work on that one. 
% 
% The basic model can be extended to incorporate the fact that some infectors have not been sampled, and therefore some infections cannot be reconstructed.
% % This will be modeled by $A_i=0$ when $i$'s infector has not been observed. 
% We introduce the parameter $\pi$, which is the probability of having observed the infector of a given case.
% Then the expression (1) becomes:
% \begin{equation}
%  p(s_i, t_i, T_i^{inf}, A_i, w, \mu_1, \kappa, \pi)
% \end{equation}
% which can be decomposed in:
% \begin{eqnarray}
% & & p(s_i | t_i, T_i^{inf}, A_i, w, \mu_1, \kappa, \pi)  p(t_i, T_i^{inf}, A_i, w, \mu_1, \kappa, \pi)\\
% &=& p(s_i | t_i, T_i^{inf}, A_i, w, \mu_1, \kappa, \pi)  p(T_i^{inf} | t_i, A_i, w, \mu_1, \kappa, \pi) p(t_i, A_i, w, \mu_1, \kappa, \pi)\\
% &=& \underbrace{p(s_i | t_i, T_i^{inf}, A_i, \mu_1, \kappa, \pi)}_{\Omega^*_1}  
%     \underbrace{p(T_i^{inf} | A_i, w, \pi)}_{\Omega^*_2}
%     \underbrace{p(t_i, A_i, w, \mu_1, \kappa, \pi)}_{\Omega^*_3} 
% \end{eqnarray}
% The first two terms are simply given by $\Omega^*_1 = \pi \Omega_i^1$ and $\Omega^*_2 = \pi \Omega_i^2$
% 
% % 
% 
% 
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% \subsection*{Prior level}
% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% %%%%%%%
% 
% For all model parameters, independent prior distributions were chosen: 
% \begin{itemize}
% 	\item uniform on $[0,1]$ for $\psi$, $\phi$, $\pi$, $\nu_1$ and $\nu_2$
% 	\item uniform on $[0,100]$ for $\kappa$ 
% 	\item uniform on $[0-1000]$ for $\mu_{\alpha}$
% 	\item flat exponential (mean 1000) for all other parameters. 
% \end{itemize}
% 
%   
% \section*{Parameter Estimation}
% 
% A Markov chain Monte Carlo (MCMC) method was used to sample the joint
% posterior distribution $P\left(\bm{Y},\bm{Z},\bm{\theta}\right)$.
% $\psi$, $\phi$ and $\pi$ were updated using the Gibbs sampler, and all other parameters using a Metropolis algorithm.



\end{document}

